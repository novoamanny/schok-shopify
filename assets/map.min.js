(function($, window) {
  'use strict';

  var $doc = $(document),
    win = $(window);

  window.Shopify = window.Shopify || {};
  window.Shopify.theme = window.Shopify.theme || {};
  window.Shopify.theme.sections = window.Shopify.theme.sections || {};

  var MAP = MAP || {};


  MAP = {
    init: function() {
      var self = this,
        obj;


      for (obj in self) {
        if (self.hasOwnProperty(obj)) {
          var _method = self[obj];
          if (_method.selector !== undefined && _method.init !== undefined) {
            if ($(_method.selector).length > 0) {
              _method.init();
            }
          }
        }
      }
    },

    contact: {
      selector: '.contact_map',
      init: function() {
        var base = this,
          container = $(base.selector);


        container.each(function() {
          var _this = $(this),
            mapzoom = _this.data('map-zoom'),
            mapstyle = _this.data('map-style'),
            mapType = _this.data('map-type'),
            panControl = _this.data('pan-control') || false,
            zoomControl = _this.data('zoom-control') || false,
            mapTypeControl = _this.data('maptype-control') || false,
            scaleControl = _this.data('scale-control') || false,
            streetViewControl = _this.data('streetview-control') || false,
            locations = _this.parents('.contact_map_wrapper').find('.thb-location'),
            map;

					if ( !window.google ) {
						return;
					}
          var bounds = new google.maps.LatLngBounds();

          var mapOptions = {
            zoom: mapzoom,
            draggable: !("ontouchend" in document),
            scrollwheel: false,
            panControl: panControl,
            zoomControl: zoomControl,
            mapTypeControl: mapTypeControl,
            scaleControl: scaleControl,
            streetViewControl: streetViewControl,
            fullscreenControl: false,
            mapTypeId: mapType,
            gestureHandling: 'cooperative'
          };

          if (mapstyle === 'light') {
            mapOptions.styles = [{
              "featureType": "water",
              "elementType": "geometry",
              "stylers": [{
                "color": "#e9e9e9"
              }, {
                "lightness": 17
              }]
            }, {
              "featureType": "landscape",
              "elementType": "geometry",
              "stylers": [{
                "color": "#f5f5f5"
              }, {
                "lightness": 20
              }]
            }, {
              "featureType": "road.highway",
              "elementType": "geometry.fill",
              "stylers": [{
                "color": "#ffffff"
              }, {
                "lightness": 17
              }]
            }, {
              "featureType": "road.highway",
              "elementType": "geometry.stroke",
              "stylers": [{
                "color": "#ffffff"
              }, {
                "lightness": 29
              }, {
                "weight": 0.2
              }]
            }, {
              "featureType": "road.arterial",
              "elementType": "geometry",
              "stylers": [{
                "color": "#ffffff"
              }, {
                "lightness": 18
              }]
            }, {
              "featureType": "road.local",
              "elementType": "geometry",
              "stylers": [{
                "color": "#ffffff"
              }, {
                "lightness": 16
              }]
            }, {
              "featureType": "poi",
              "elementType": "geometry",
              "stylers": [{
                "color": "#f5f5f5"
              }, {
                "lightness": 21
              }]
            }, {
              "featureType": "poi.park",
              "elementType": "geometry",
              "stylers": [{
                "color": "#dedede"
              }, {
                "lightness": 21
              }]
            }, {
              "elementType": "labels.text.stroke",
              "stylers": [{
                "visibility": "on"
              }, {
                "color": "#ffffff"
              }, {
                "lightness": 16
              }]
            }, {
              "elementType": "labels.text.fill",
              "stylers": [{
                "saturation": 36
              }, {
                "color": "#333333"
              }, {
                "lightness": 40
              }]
            }, {
              "elementType": "labels.icon",
              "stylers": [{
                "visibility": "off"
              }]
            }, {
              "featureType": "transit",
              "elementType": "geometry",
              "stylers": [{
                "color": "#f2f2f2"
              }, {
                "lightness": 19
              }]
            }, {
              "featureType": "administrative",
              "elementType": "geometry.fill",
              "stylers": [{
                "color": "#fefefe"
              }, {
                "lightness": 20
              }]
            }, {
              "featureType": "administrative",
              "elementType": "geometry.stroke",
              "stylers": [{
                "color": "#fefefe"
              }, {
                "lightness": 17
              }, {
                "weight": 1.2
              }]
            }];
          } else if (mapstyle === 'dark') {
            mapOptions.styles = [{
              "featureType": "all",
              "elementType": "labels.text.fill",
              "stylers": [{
                "saturation": 36
              }, {
                "color": "#000000"
              }, {
                "lightness": 40
              }]
            }, {
              "featureType": "all",
              "elementType": "labels.text.stroke",
              "stylers": [{
                "visibility": "on"
              }, {
                "color": "#000000"
              }, {
                "lightness": 16
              }]
            }, {
              "featureType": "all",
              "elementType": "labels.icon",
              "stylers": [{
                "visibility": "off"
              }]
            }, {
              "featureType": "administrative",
              "elementType": "geometry.fill",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 20
              }]
            }, {
              "featureType": "administrative",
              "elementType": "geometry.stroke",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 17
              }, {
                "weight": 1.2
              }]
            }, {
              "featureType": "landscape",
              "elementType": "geometry",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 20
              }]
            }, {
              "featureType": "poi",
              "elementType": "geometry",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 21
              }]
            }, {
              "featureType": "road.highway",
              "elementType": "geometry.fill",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 17
              }]
            }, {
              "featureType": "road.highway",
              "elementType": "geometry.stroke",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 29
              }, {
                "weight": 0.2
              }]
            }, {
              "featureType": "road.arterial",
              "elementType": "geometry",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 18
              }]
            }, {
              "featureType": "road.local",
              "elementType": "geometry",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 16
              }]
            }, {
              "featureType": "transit",
              "elementType": "geometry",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 19
              }]
            }, {
              "featureType": "water",
              "elementType": "geometry",
              "stylers": [{
                "color": "#000000"
              }, {
                "lightness": 17
              }]
            }];
          }
          map = new google.maps.Map(_this[0], mapOptions);

          // Render Marker
          function thb_renderMarker(i, location, rendered) {
            var options = location.data('option'),
              lat = options.latitude,
              long = options.longitude,
              latlng = new google.maps.LatLng(lat, long),
              marker = options.marker_image,
              marker_size = location.data('option').marker_size,
              retina = options.retina_marker,
              title = options.marker_title,
              desc = options.marker_description,
              pinimageLoad = new Image();

            bounds.extend(latlng);

            pinimageLoad.src = marker;

            $(pinimageLoad).on('load', function() {
              base.setMarkers(i, map, latlng, marker, marker_size, title, desc, retina, rendered);
            });
          }

          locations.each(function(i) {
            thb_renderMarker(i, $(this), $(this).data('rendered'));
            $(this).data('rendered', true);

          });

          google.maps.event.addListenerOnce(map, 'tilesloaded', function() {
            if (mapzoom > 0) {
              map.setCenter(bounds.getCenter());
              map.setZoom(mapzoom);
            } else {
              map.setCenter(bounds.getCenter());
              map.fitBounds(bounds);
            }
          });

          win.on('resize.google_map', function() {
            setTimeout(function() {
              map.setCenter(bounds.getCenter());
            }, 50);
          }).trigger('resize.google_map');

        });
      },
      setMarkers: function(i, map, latlng, marker, marker_size, title, desc, retina, rendered) {
        // info windows
        var contentString = '<h3>' + title + '</h3>' + '<div>' + desc + '</div>',
          infowindow = new google.maps.InfoWindow({
            content: contentString
          });

        if (retina && !rendered) {
          marker_size[0] = marker_size[0] / 2;
          marker_size[1] = marker_size[1] / 2;
        }

        function CustomMarker(latlng, map) {
          this.latlng = latlng;
          this.setMap(map);
        }

        CustomMarker.prototype = new google.maps.OverlayView();

        CustomMarker.prototype.draw = function() {
          var self = this;
          var div = this.div_;
          if (!div) {
            div = this.div_ = $('' +
              '<div class="thb_pin">' +
              '<div class="pulse"></div>' +
              '<div class="shadow"></div>' +
              '<div class="pin-wrap"><img src="' + marker + '" width="' + marker_size[0] + '" height="' + marker_size[1] + '"/></div>' +
              '</div>' +
              '');
            this.pinShadow = this.div_.find('.shadow');
            this.pulse = this.div_.find('.pulse');
            this.div_[0].style.position = 'absolute';
            this.div_[0].style.cursor = 'pointer';

            var panes = this.getPanes();
            panes.overlayImage.appendChild(this.div_[0]);

            google.maps.event.addDomListener(div[0], "click", function(event) {
              infowindow.setPosition(latlng);
              infowindow.open(map);
            });

          }

          var point = this.getProjection().fromLatLngToDivPixel(latlng);

          if (point) {
            var shadow_offset = ((marker_size[0] - 40) / 2);

            this.div_[0].style.left = point.x - (marker_size[0] / 2) + 'px';
            this.div_[0].style.top = point.y - (marker_size[1] / 2) + 'px';
            this.div_[0].style.width = marker_size[0] + 'px';
            this.div_[0].style.height = marker_size[1] + 'px';
            this.pinShadow[0].style.marginLeft = shadow_offset + 'px';
            this.pulse[0].style.marginLeft = shadow_offset + 'px';
          }


        };
        CustomMarker.prototype.remove = function() {
          if (this.div_) {
            this.div_.parentNode.removeChild(this.div_);
            this.div_ = null;
          }
        };

        CustomMarker.prototype.getPosition = function() {
          return this.latlng;
        };

        var g_marker = new CustomMarker(latlng, map);
      }
    }
  };


  if (window.Shopify.designMode || window.Shopify.hasSections) {
    $(document).on('shopify:section:select shopify:block:select shopify:section:load', function() {
      var id = event.detail.sectionId;
      MAP.init();
    });
  } else {
    $(function() {
      MAP.init();
    });
  }

})(jQuery, this);
